# Google Calendar Credential Setup Guide

This guide explains how to set up Google OAuth2 credentials for the Smart Scheduler iOS/macOS app.

## Overview

The app uses OAuth2 to authenticate with Google Calendar. The authentication flow works as follows:

1. **App handles OAuth** - The Swift app manages the OAuth flow using `ASWebAuthenticationSession`
2. **Tokens stored securely** - Access tokens and refresh tokens are stored in the iOS/macOS Keychain
3. **Tokens sent to backend** - The app sends the access token with each API request
4. **Backend uses tokens** - The backend uses the access token to make Google Calendar API calls

## Setup Steps

### 1. Create OAuth 2.0 Credentials in Google Cloud Console

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Select your project (or create a new one)
3. Navigate to **APIs & Services** > **Credentials**
4. Click **Create Credentials** > **OAuth 2.0 Client ID**

### 2. Configure OAuth Client (IMPORTANT: Use "iOS")

**✅ Important:** Create an **"iOS"** OAuth client. iOS clients don't require client secrets and use PKCE for security.

1. Application type: **iOS**
2. Name: Smart Scheduler iOS (or any name you prefer)
3. **Bundle ID**: Enter your app's bundle ID (e.g., `sat.smart-scheduler-fe` - must match Xcode exactly)
4. **App Store ID**: (Optional) Leave blank if not published yet
5. Save the **Client ID** and note the **iOS URL scheme** (you'll need both!)
   - iOS clients don't have client secrets - they rely on PKCE for security
   - Google will auto-generate an iOS URL scheme (shown in "Additional information" section)
   - The iOS URL scheme will be in format: `com.googleusercontent.apps.{CLIENT_ID_PART}`
   - You'll use this iOS URL scheme in your code and Xcode configuration

### 3. Configure OAuth Consent Screen

1. Go to **APIs & Services** > **OAuth consent screen**
2. Fill in the required information:
   - User Type: External (or Internal if using Google Workspace)
   - App name: Smart Scheduler
   - User support email: Your email
   - Developer contact: Your email
3. Add scopes:
   - `https://www.googleapis.com/auth/calendar.events`
   - `https://www.googleapis.com/auth/calendar.readonly`
4. Add test users (if app is in testing mode)

### 4. Configure URL Scheme in Xcode

**⚠️ Important:** For iOS OAuth clients, you must use Google's auto-generated iOS URL scheme (shown in Google Cloud Console as "iOS URL scheme"), NOT a custom one.

1. Open your Xcode project
2. Select your app target
3. Go to **Info** tab
4. Under **URL Types**, click **+** to add a new URL type:
   - **Identifier**: `com.google.oauth`
   - **URL Schemes**: `com.googleusercontent.apps.167925471103-qpepk4psv6m38i6tnbctkum3rjmn58eo` (use YOUR iOS URL scheme from Google Cloud Console)
   - **Role**: Editor

**How to find your iOS URL scheme:**
- In Google Cloud Console, open your iOS OAuth client
- Look for the "iOS URL scheme" field in the "Additional information" section
- It will be in the format: `com.googleusercontent.apps.{CLIENT_ID_PART}`
- Copy this exact value and use it as your URL Scheme in Xcode

This URL scheme is what `ASWebAuthenticationSession` will use to redirect back to your app after authentication.

### 5. Update Client ID and iOS URL Scheme in Code

1. Open `OAuthConfig.swift` (configuration is now separated from the main auth manager)
2. Find these lines:
   ```swift
   static let clientId = "YOUR_IOS_CLIENT_ID_HERE"
   static let iosURLScheme = "YOUR_IOS_URL_SCHEME_HERE"
   ```
3. Replace with your values from Google Cloud Console:
   - **Client ID**: Copy from "Client ID" field
   - **iOS URL scheme**: Copy from "iOS URL scheme" field (in Additional information section)

**Example:**
```swift
static let clientId = "167925471103-qpepk4psv6m38i6tnbctkum3rjmn58eo.apps.googleusercontent.com"
static let iosURLScheme = "com.googleusercontent.apps.167925471103-qpepk4psv6m38i6tnbctkum3rjmn58eo"
```

**Note:** The `redirectURI` and `callbackURLScheme` are automatically derived from `iosURLScheme`, so you only need to update the two values above.

**✅ Security Note**: iOS OAuth clients don't require client secrets! The client ID is safe to embed in your app - it's meant to be public. Security is provided by PKCE (Proof Key for Code Exchange).

**✅ Better Organization**: Configuration values are now in a separate `OAuthConfig.swift` file, making it easier to:
- Update values without touching the main auth logic
- Support different environments (dev/staging/prod) in the future
- Keep configuration separate from implementation

### 6. Verify Redirect URI Configuration

**For iOS OAuth clients:**
- **Google Cloud Console iOS URL scheme**: `com.googleusercontent.apps.167925471103-qpepk4psv6m38i6tnbctkum3rjmn58eo` (auto-generated by Google)
- **App redirect URI**: `com.googleusercontent.apps.167925471103-qpepk4psv6m38i6tnbctkum3rjmn58eo:/oauth/callback` (used in code)
- **App callback URL scheme**: `com.googleusercontent.apps.167925471103-qpepk4psv6m38i6tnbctkum3rjmn58eo` (configured in Xcode)
- **No HTML redirect page needed!** iOS clients use Google's auto-generated URL scheme.

Make sure:

1. ✅ The iOS URL scheme in Google Cloud Console matches what you use in code
2. ✅ The URL scheme in Xcode matches the iOS URL scheme from Google Cloud Console
3. ✅ The `redirectURI` in `GoogleAuthManager.swift` uses the format: `{iOS_URL_SCHEME}:/oauth/callback`
4. ✅ The `callbackURLScheme` in `GoogleAuthManager.swift` matches the URL scheme in Xcode

**How it works:** 
- Google redirects directly to `com.googleusercontent.apps.167925471103-qpepk4psv6m38i6tnbctkum3rjmn58eo:/oauth/callback?code=...`
- `ASWebAuthenticationSession` intercepts the URL scheme and closes the popup
- Your app receives the callback and completes the OAuth flow
- No intermediate HTML page needed!

## How It Works

### Authentication Flow

```
User taps "Sign in with Google"
    ↓
App opens ASWebAuthenticationSession (popup)
    ↓
User authorizes in popup
    ↓
Google redirects directly to: com.googleusercontent.apps.167925471103-qpepk4psv6m38i6tnbctkum3rjmn58eo:/oauth/callback?code=...
    ↓
ASWebAuthenticationSession intercepts custom scheme
    ↓
Popup closes, app receives callback URL
    ↓
App extracts authorization code
    ↓
App exchanges code for access_token + refresh_token (using PKCE, no client_secret)
    ↓
Tokens stored in Keychain
    ↓
App can now make API calls with access_token
```

### Token Management

- **Access Token**: Short-lived (typically 1 hour), sent with each API request
- **Refresh Token**: Long-lived, used to get new access tokens when they expire
- **Automatic Refresh**: The app automatically refreshes expired access tokens using the refresh token
- **Secure Storage**: All tokens stored in iOS/macOS Keychain (encrypted)

### Backend Integration

The backend (`app.py`) already accepts `access_token` in request bodies:

```python
class ScheduleRequest(BaseModel):
    rant: str
    access_token: str  # ← App sends this
```

The backend uses the token to create Google Calendar service instances:

```python
calendar_manager = CalendarManager(access_token=req.access_token)
```

## Security Considerations

1. **Client ID is safe to embed**: The iOS client ID is meant to be public - it's safe to include in your app code
2. **No client secret needed**: iOS OAuth clients use PKCE (Proof Key for Code Exchange) for security instead of client secrets
3. **Keychain storage**: Tokens are automatically encrypted by iOS/macOS Keychain
4. **HTTPS only**: All API calls should use HTTPS in production
5. **Token expiration**: Access tokens expire after 1 hour; refresh tokens are used automatically

## Troubleshooting

### "Access blocked: Authorization Error - Error 400: invalid_request"
**This error means the app doesn't comply with Google's OAuth 2.0 policy.** Common causes:

1. **Bundle ID Mismatch** ⚠️ Most common!
   - Your app's Bundle ID is: `sat.smart-scheduler-fe` (from Xcode)
   - The Bundle ID in Google Cloud Console must match **exactly**
   - Go to Google Cloud Console > Credentials > Your iOS OAuth Client
   - Verify the Bundle ID is exactly: `sat.smart-scheduler-fe`
   - If it's different, edit the client or create a new one with the correct Bundle ID

2. **OAuth Consent Screen Not Configured**
   - Go to **APIs & Services** > **OAuth consent screen**
   - Make sure all required fields are filled:
     - App name
     - User support email
     - Developer contact email
     - Scopes are added (calendar.events, calendar.readonly)
   - Save the configuration

3. **App in Testing Mode - User Not Added**
   - If your app is in "Testing" mode, you must add test users
   - Go to **OAuth consent screen** > **Test users**
   - Click **+ ADD USERS**
   - Add the email address you're trying to sign in with (`satcls10@gmail.com`)
   - Wait a few minutes for changes to propagate

4. **iOS URL Scheme Mismatch**
   - For iOS OAuth clients, you MUST use Google's auto-generated iOS URL scheme
   - Find your iOS URL scheme in Google Cloud Console (under "Additional information")
   - Verify `redirectURI` in `GoogleAuthManager.swift` uses format: `{iOS_URL_SCHEME}:/oauth/callback`
   - Verify `callbackURLScheme` in `GoogleAuthManager.swift` matches the iOS URL scheme
   - Verify the URL scheme in Xcode matches the iOS URL scheme exactly

**Quick Fix Checklist:**
- ✅ Bundle ID in Google Cloud Console = `sat.smart-scheduler-fe` (matches Xcode exactly)
- ✅ Using Google's iOS URL scheme (not a custom one): `com.googleusercontent.apps.167925471103-qpepk4psv6m38i6tnbctkum3rjmn58eo`
- ✅ `redirectURI` in code = `{iOS_URL_SCHEME}:/oauth/callback`
- ✅ URL scheme in Xcode = iOS URL scheme from Google Cloud Console
- ✅ OAuth consent screen is fully configured
- ✅ If in testing mode, your email is added as a test user
- ✅ Wait 5-10 minutes after making changes for Google to propagate them

### "Access blocked: Authorization Error - Error 401: invalid_client"
**This is the most common error!** It means:
- ❌ The `clientId` is still set to `"YOUR_IOS_CLIENT_ID_HERE"` (placeholder)
- ❌ You created a Web application OAuth client instead of an iOS client
- ❌ The Client ID doesn't exist or is from a different project
- ❌ The Bundle ID doesn't match your app's bundle ID

**Solution:**
1. Make sure you created an **"iOS"** OAuth client (not Web application)
2. Verify the Bundle ID in Google Cloud Console matches your app's bundle ID
3. Copy the Client ID from Google Cloud Console
4. Replace `"YOUR_IOS_CLIENT_ID_HERE"` in `GoogleAuthManager.swift` with your actual Client ID
5. Make sure you're using Google's iOS URL scheme (not a custom one)

### "Invalid redirect URI" error
**This happens when the redirect URI doesn't match Google's iOS URL scheme.**

**Solution:**
- For iOS OAuth clients, you MUST use Google's auto-generated iOS URL scheme
- Find your iOS URL scheme in Google Cloud Console (under "Additional information" > "iOS URL scheme")
- Use this format for `redirectURI`: `{iOS_URL_SCHEME}:/oauth/callback`
- Make sure the URL scheme in Xcode matches the iOS URL scheme exactly
- The redirect URI must match exactly (including the `:/` part)

### "Token refresh failed" error
- The refresh token may have been revoked
- User needs to re-authenticate

### "Not authenticated" error
- Check that `clientId` is set correctly (not the placeholder)
- Verify OAuth consent screen is configured
- Ensure the redirect URI is properly configured

## Alternative: Using Google Sign-In SDK

For a more integrated experience, you could use the [Google Sign-In SDK](https://developers.google.com/identity/sign-in/ios) instead of manual OAuth2. This would require:

1. Adding the SDK via Swift Package Manager or CocoaPods
2. Different authentication flow
3. Similar token management approach

The current implementation uses manual OAuth2 for more control and fewer dependencies.

